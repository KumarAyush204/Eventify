<%- include ('../partials/head') %>
<%- include ('../partials/nav') %>

<div class="bg-gradient-to-br from-red-50 via-white to-pink-50 min-h-screen py-10 px-4 flex items-center justify-center">

  <div class="bg-white shadow-md rounded-2xl p-5 w-full max-w-md flex flex-col hover:shadow-xl transition-shadow duration-300">

    <!-- IMAGE -->
    <div class="relative mb-3 group">
      <img 
        src="/<%= home.photoUrl %>" 
        alt="<%= home.housename %>" 
        class="w-full h-56 object-cover rounded-lg transform group-hover:scale-105 transition-transform duration-500"
      />

      <span class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
        <%= home.venueType || 'Venue' %>
      </span>

      <div class="absolute top-3 right-3 bg-white px-2 py-1 rounded-full shadow text-sm font-semibold flex items-center gap-1">
        <i class="fas fa-star text-yellow-400"></i>
        <%= home.rating %>
      </div>
    </div>

    <!-- TITLE -->
    <h3 class="text-red-700 font-bold text-xl mb-2"><%= home.housename %></h3>

    <!-- DETAILS -->
    <div class="space-y-2 mb-4">

      <p class="text-sm text-gray-600">
        <span class="font-semibold text-gray-700">Address:</span> <%= home.address %>
      </p>

      <p class="text-sm text-gray-600">
        <span class="font-semibold text-gray-700">Capacity:</span> <%= home.capacity %> Guests
      </p>

      <p class="text-sm text-gray-600">
        <span class="font-semibold text-gray-700">Price/Day:</span> â‚¹<%= home.price %>
      </p>

      <div class="pt-3 border-t border-gray-100">
        <p class="text-sm text-gray-600">
          <span class="font-semibold text-gray-700">Features:</span> 
          <%= home.facilities %>
        </p>
      </div>

    </div>

    <!-- BUTTONS -->
    <div class="flex flex-col gap-3 mt-auto">

      <% if (!user || user.usertype !== 'host') { %>
        <a href="/book/<%= home._id %>" 
           class="block w-full bg-red-700 text-white font-semibold py-2 rounded-lg text-center hover:bg-red-800 shadow-md transition duration-300">
          Book For Event
        </a>
      <% } %>

      <div class="flex gap-3">

        <% if (!user || user.usertype !== 'host') { %>
          <form action="/favourites" method="POST" class="flex-1">
            <input type="hidden" name="id" value="<%= home._id %>">
            <button 
              type="submit" 
              class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-50 transition duration-300 text-sm flex items-center justify-center gap-1">
              <i class="far fa-heart text-red-500"></i> Save
            </button>
          </form>
        <% } %>

        <% if (home.rulesPdfUrl) { %>
          <a href="/<%= home.rulesPdfUrl %>" target="_blank"
             class="flex-1 bg-white border border-blue-200 text-blue-600 font-semibold py-2 rounded-lg hover:bg-blue-50 transition duration-300 text-center text-sm flex items-center justify-center gap-1">
            <i class="fas fa-file-pdf"></i> Rules
          </a>
        <% } %>

      </div>
    </div>

  </div>
</div>

<!-- CHAT WIDGET (unchanged) -->
<div id="chat-widget" class="fixed bottom-5 right-5 z-50 font-sans">
  <div id="chat-window" class="hidden bg-white w-80 h-96 rounded-2xl shadow-2xl flex flex-col border border-gray-200 mb-4 overflow-hidden transition-all transform origin-bottom-right duration-300">
    <div class="bg-red-700 text-white p-4 flex justify-between items-center shadow-md">
      <h3 class="font-bold text-sm flex items-center gap-2"><i class="fas fa-robot"></i> Ask about <%= home.housename %></h3>
      <button onclick="toggleChat()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
    </div>
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3 text-sm">
      <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm border border-gray-200 self-start text-gray-700 max-w-[90%]">
        Hello! I know the facilities and rules for <strong><%= home.housename %></strong>. Ask me anything!
      </div>
    </div>
    <div class="p-3 bg-white border-t border-gray-100 flex gap-2">
      <input type="text" id="user-input" placeholder="Ask a question..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-red-500">
      <button onclick="sendMessage()" id="send-btn" class="bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-700 shadow-md transition"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <button onclick="toggleChat()" class="bg-red-600 hover:bg-red-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl transition-transform hover:scale-110">
    <i class="fas fa-comment-dots"></i>
  </button>
</div>

<script>
  const homeId = "<%= home._id %>";
  const chatWindow = document.getElementById('chat-window');
  const messagesContainer = document.getElementById('chat-messages');
  const userInput = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');

  function toggleChat() {
    chatWindow.classList.toggle('hidden');
    if (!chatWindow.classList.contains('hidden')) userInput.focus();
  }

  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    // 1. Disable input while sending
    userInput.disabled = true;
    sendBtn.disabled = true;

    // 2. Add User Message
    addMessage(message, 'user');
    userInput.value = '';

    // 3. Add Typing Indicator
    const typingId = addMessage('Thinking...', 'bot', true);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ homeId: homeId, userMessage: message })
      });
      
      const data = await response.json();
      
      // 4. Remove Typing & Add Bot Response
      removeMessage(typingId);
      addMessage(data.reply, 'bot');

    } catch (error) {
      removeMessage(typingId);
      addMessage("Error connecting to AI.", 'bot');
    } finally {
      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.focus();
    }
  }

  function addMessage(text, sender, isTyping = false) {
    const div = document.createElement('div');
    // FIX: Add a random number to ensure the ID is always unique
    const id = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    div.id = id;
    
    if (sender === 'user') {
      div.className = "bg-red-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm self-end ml-auto max-w-[85%]";
    } else {
      div.className = "bg-white text-gray-800 p-3 rounded-lg rounded-tl-none shadow-sm border border-gray-200 mr-auto max-w-[85%]";
      if (isTyping) div.classList.add('italic', 'text-gray-500');
    }
    
    // Allow line breaks
    div.innerHTML = text.replace(/\n/g, '<br>'); 
    
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return id;
  }

  function removeMessage(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }

  userInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendMessage();
  });
</script>